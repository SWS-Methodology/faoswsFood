suppressMessages({
    library(data.table)
    library(faosws)
    library(dplyr)
    library(faoswsUtil)
    library(faoswsFood)
    #library(reshape2)
})

if(!CheckDebug()){
    options(error = function(){
        dump.frames()
        save(last.dump, file="/work/SWS_R_Share/caetano/last.dump.RData")
    })
}


## To do:
## - Check the input dataset from Josef against what's on the server: ask Nick for
## the file that Jim gave him with the elasticities, compare with Josef's file
## and figure out why we have differences.  Reload if necessary.

## set up for the test environment and parameters
R_SWS_SHARE_PATH <- Sys.getenv("R_SWS_SHARE_PATH")
DEBUG_MODE <- Sys.getenv("R_DEBUG_MODE")
overwritableFlags = c("M", "I")

# This return FALSE if on the Statistical Working System
if(CheckDebug()){
    
    message("Not on server, so setting up environment...")
    
    library(faoswsModules)
    SETTINGS <- ReadSettings("modules/impute_food/sws.yml")
    
    # If you're not on the system, your settings will overwrite any others
    R_SWS_SHARE_PATH <- SETTINGS[["share"]]
    
    # Define where your certificates are stored
    SetClientFiles(SETTINGS[["certdir"]])
    
    # Get session information from SWS. Token must be obtained from web interface
    GetTestEnvironment(baseUrl = SETTINGS[["server"]],
                       token = SETTINGS[["token"]])
    files = dir("~/Github/faoswsFood/R", full.names = TRUE)
    sapply(files, source)
    
}

if(swsContext.computationParams$yearToProcess < 1999)
    stop("This module was designed for imputation on years after 1998 only!")

cat("Defining variables/dimensions/keys/...\n")

## Define the keys that we'll need for all the dimensions
## set the keys to get the population data from the FAO working system
#areaCodesM49 <- swsContext.datasets[[1]]@dimensions$geographicAreaM49@keys
#areaCodesM49 <- GetCodeList("agriculture", "aproduction", "geographicAreaM49")[type == "country",code]
areaCodesM49 <- c("4", "8", "12", "24", "28", "32", "51", "36", "40", "31", "44", 
                  "50", "52", "112", "56", "84", "204", "60", "68", "70", "72", 
                  "76", "96", "100", "854", "108", "116", "120", "124", "132", 
                  "140", "148", "152", "344", "446", "1248", "170", "174", "178", 
                  "188", "384", "191", "192", "196", "203", "408", "180", "208", 
                  "262", "212", "214", "218", "818", "222", "232", "233", "231", 
                  "242", "246", "250", "254", "258", "266", "270", "268", "276", 
                  "288", "300", "308", "312", "320", "324", "624", "328", "332", 
                  "340", "348", "352", "356", "360", "364", "368", "372", "376", 
                  "380", "388", "392", "400", "398", "404", "296", "414", "417", 
                  "418", "428", "422", "426", "430", "434", "440", "450", "454", 
                  "458", "462", "466", "470", "474", "478", "480", "484", "496", 
                  "499", "504", "508", "104", "516", "524", "530", "528", "540", 
                  "554", "558", "562", "566", "578", "586", "275", "591", "598", 
                  "600", "604", "608", "616", "620", "410", "498", "638", "642", 
                  "643", "646", "659", "662", "670", "882", "678", "682", "686", 
                  "688", "690", "694", "703", "705", "90", "706", "710", "724", 
                  "144", "740", "748", "752", "756", "760", "762", "807", "764", 
                  "626", "768", "780", "788", "792", "795", "800", "804", "784", 
                  "826", "834", "840", "858", "860", "548", "862", "704", "887", 
                  "894", "716")
itemCodesCPC <- c("CPC", "0", "01", "011", "0111", "0112", "0113", "0114", "0115", 
                  "0116", "0117", "0118", "0119", "01190", "01191", "01192", "01193", 
                  "01194", "01195", "01199", "01199.01", "01199.02", "01199.90", 
                  "012", "0121", "01211", "01212", "01213", "01214", "01215", "01216", 
                  "01219", "01219.01", "01219.90", "0122", "01221", "01229", "0123", 
                  "01231", "01232", "01233", "01234", "01235", "01239", "01239.01", 
                  "01239.90", "0124", "01241", "01241.01", "01241.90", "01242", 
                  "01243", "01249", "0125", "01251", "01252", "01253", "01253.01", 
                  "01253.02", "01254", "01259", "0126", "01260", "0127", "01270", 
                  "0129", "01290", "01290.01", "01290.90", "013", "0131", "01311", 
                  "01312", "01312.01", "01312.02", "01313", "01313.01", "01313.02", 
                  "01314", "01315", "01316", "01316.01", "01316.02", "01316.03", 
                  "01317", "01318", "01319", "0132", "01321", "01322", "01323", 
                  "01324", "01324.01", "01324.02", "01329", "0133", "01330", "0134", 
                  "01341", "01342", "01342.01", "01342.02", "01343", "01344", "01344.01", 
                  "01344.02", "01345", "01346", "01349", "01349.10", "01349.20", 
                  "0135", "01351", "01351.01", "01351.02", "01352", "01353", "01353.01", 
                  "01353.02", "01354", "01355", "01355.01", "01355.02", "01355.90", 
                  "01356", "01359", "01359.01", "01359.02", "01359.90", "0136", 
                  "01360", "0137", "01371", "01372", "01373", "01374", "01375", 
                  "01376", "01377", "01379", "01379.01", "01379.02", "01379.90", 
                  "0139", "01391", "01399", "014", "0141", "0142", "01422", "0143", 
                  "0144", "01441", "01442", "01443", "01444", "01445", "01446", 
                  "01447", "01448", "01449", "01449.01", "01449.02", "01449.90", 
                  "0145", "01450", "0146", "01460", "0149", "01491", "01491.01", 
                  "01491.02", "01492", "01499", "01499.01", "01499.02", "01499.03", 
                  "01499.04", "01499.05", "01499.06", "01499.07", "01499.90", "015", 
                  "0151", "01510", "0152", "01520", "01520.01", "01520.02", "0153", 
                  "01530", "0154", "01540", "0155", "01550", "0159", "01591", "01599", 
                  "01599.10", "01599.20", "016", "0161", "01610", "0162", "01620", 
                  "01620.01", "01620.02", "0163", "01630", "0164", "01640", "0165", 
                  "01651", "01652", "01653", "01654", "01655", "01656", "01657", 
                  "01658", "01659", "0169", "01690", "01691", "01699", "017", "0170", 
                  "01701", "01702", "01703", "01704", "01705", "01706", "01707", 
                  "01708", "01709", "01709.01", "01709.02", "01709.90", "018", 
                  "0180", "01801", "01802", "01803", "01809", "019", "0191", "01911", 
                  "01912", "01913", "01919", "01919.06", "01919.08", "01919.09", 
                  "01919.01", "01919.02", "01919.91", "01919.03", "01919.94", "01919.92", 
                  "01919.04", "01919.93", "01919.05", "01919.07", "01919.10", "01919.11", 
                  "01919.96", "39120.92", "01919.95", "0192", "01921", "01921.01", 
                  "01921.02", "01922", "01922.01", "01922.02", "01929", "01929.01", 
                  "01929.02", "01929.04", "01929.05", "01929.07", "01929.08", "01929.03", 
                  "01929.90", "01929.06", "0193", "01930", "01930.01", "01930.02", 
                  "01930.03", "01930.04", "01930.90", "0194", "01940", "0195", 
                  "01950", "01950.01", "01950.02", "0196", "01961", "01962", "01963", 
                  "0197", "01970", "0199", "01990", "01990.01", "01990.90", "02", 
                  "021", "0211", "02111", "02112", "02119", "0212", "02121", "02121.01", 
                  "02121.02", "02122", "02123", "02129", "0213", "02130", "02131", 
                  "02132", "02133", "0214", "02140", "0215", "02151", "02152", 
                  "02153", "02154", "02155", "0219", "02191", "02192", "02192.01", 
                  "02192.90", "02193", "02194", "02195", "02196", "02199", "02199.10", 
                  "02199.20", "022", "0221", "02211", "02212", "0229", "02291", 
                  "02292", "02293", "02299", "023", "0231", "02311", "02312", "0232", 
                  "02320", "02321", "02322", "0233", "024", "0241", "02411", "02419", 
                  "0242", "02420", "029", "0291", "02910", "0292", "02920", "0293", 
                  "02930", "0294", "02941", "02942", "02942.01", "02942.02", "02942.90", 
                  "02943", "02943.01", "02943.02", "02944", "0294A", "0295", "02951", 
                  "02951.01", "02951.02", "02951.03", "02951.04", "02951.05", "02951.06", 
                  "02951.07", "02951.08", "02951.09", "02951.91", "02951.92", "02952", 
                  "02952.01", "02952.02", "02952.03", "02952.04", "02952.05", "02952.91", 
                  "02953", "02953.01", "02953.02", "02953.03", "02953.04", "02953.90", 
                  "02954", "02954.01", "02954.02", "02954.90", "02955", "02955.01", 
                  "02955.02", "02955.90", "02959", "02959.01", "02959.02", "02959.03", 
                  "02959.04", "02959.05", "02959.06", "02959.07", "02959.08", "02959.20", 
                  "02959.30", "02959.99", "02959.91", "0296", "02960", "02960.01", 
                  "02960.02", "03", "031", "0311", "03110", "0312", "03120", "0313", 
                  "03130", "03131", "03132", "032", "0321", "03211", "03219", "03219.01", 
                  "03219.90", "0322", "03220", "0323", "03230", "03231", "03239", 
                  "0324", "03241", "03249", "0325", "03250", "04", "041", "0411", 
                  "04111", "04112", "04119", "0412", "04120", "0419", "04191", 
                  "04192", "042", "0421", "04210", "04211", "04212", "0422", "04220", 
                  "04221", "04222", "0423", "04231", "04232", "0424", "04241", 
                  "04242", "0425", "04251", "04252", "0429", "04291", "04292", 
                  "04299", "043", "0431", "04311", "04312", "0432", "04322", "0433", 
                  "04331", "04332", "0434", "04341", "04342", "0435", "04351", 
                  "04352", "0436", "04361", "04362", "0439", "04391", "04392", 
                  "044", "0441", "04411", "04412", "0442", "04421", "04422", "0443", 
                  "04431", "04432", "0444", "04441", "04442", "0445", "04451", 
                  "04452", "0446", "04461", "04462", "0447", "04471", "04472", 
                  "0449", "04491", "04492", "045", "0451", "04511", "04512", "0452", 
                  "04521", "04522", "0453", "04530", "0459", "04590", "049", "0491", 
                  "04910", "04911", "04912", "04913", "0492", "04920", "0493", 
                  "04930", "04931", "04932", "04933", "04934", "1", "11", "110", 
                  "1101", "11010", "1102", "11020", "1103", "11030", "1104", "11040", 
                  "1105", "11050", "12", "120", "1201", "12010", "1202", "12020", 
                  "1203", "12030", "13", "130", "1300", "13000", "14", "141", "1410", 
                  "14100", "142", "1421", "14210", "1422", "14220", "1423", "14230", 
                  "1424", "14240", "1429", "14290", "15", "151", "1511", "15110", 
                  "1512", "15120", "1513", "15130", "152", "1520", "15200", "153", 
                  "1531", "15310", "1532", "15320", "1533", "15330", "154", "1540", 
                  "15400", "16", "161", "1611", "16110", "1612", "16120", "1619", 
                  "16190", "162", "1620", "16200", "163", "1631", "16310", "1632", 
                  "16320", "1633", "16330", "1639", "16390", "17", "171", "1710", 
                  "17100", "172", "1720", "17200", "173", "1730", "17300", "174", 
                  "1740", "17400", "18", "180", "1800", "18000", "2", "21", "211", 
                  "2111", "21111", "21111.01", "21111.02", "21112", "21113", "21113.01", 
                  "21113.02", "21114", "21115", "21116", "21117", "21117.01", "21117.02", 
                  "21118", "21118.01", "21118.02", "21118.03", "21119", "21119.01", 
                  "21119.90", "2112", "21121", "21122", "21123", "21124", "21125", 
                  "2113", "21131", "21131.01", "21131.02", "21132", "21133", "21133.01", 
                  "21133.02", "21134", "21135", "21136", "21137", "21137.01", "21137.02", 
                  "21138", "21138.01", "21138.02", "21138.03", "21139", "2114", 
                  "21141", "21142", "21143", "21144", "21145", "2115", "21151", 
                  "21152", "21153", "21155", "21156", "21159", "21159.01", "21159.02", 
                  "21159.90", "2116", "21160", "21160.01", "21160.02", "21160.03", 
                  "21160.04", "2117", "21170", "21170.01", "21170.02", "21170.92", 
                  "21170.93", "21171", "21172", "21173", "21174", "21175", "21176", 
                  "21179", "2118", "21180", "21181", "21182", "21183", "21184", 
                  "21184.01", "21184.02", "21184.03", "21185", "21186", "21186.01", 
                  "21186.02", "21186.03", "21186.90", "21189", "21189.01", "21189.02", 
                  "21189.03", "21189.04", "21189.05", "21189.90", "2118A", "2118B", 
                  "2118C", "2118D", "2119", "21190", "21190.01", "21190.02", "21190.90", 
                  "212", "2121", "21210", "21211", "21212", "21213", "21214", "21215", 
                  "21216", "21219", "2122", "21221", "21222", "21223", "21224", 
                  "21225", "21226", "21227", "2123", "21231", "21232", "21233", 
                  "21234", "2124", "21241", "21242", "21243", "2125", "21250", 
                  "21251", "21252", "21253", "21254", "21255", "21256", "21259", 
                  "2126", "21261", "21262", "21263", "21264", "21265", "21266", 
                  "21267", "21268", "21269", "2127", "21270", "2128", "21280", 
                  "2129", "21291", "21299", "213", "2131", "21311", "21312", "21313", 
                  "21319", "21319.01", "21319.90", "2132", "21321", "21329", "2133", 
                  "21330", "21330.01", "21330.90", "2134", "21340", "21340.01", 
                  "21340.90", "2139", "21391", "21392", "21393", "21393.01", "21393.90", 
                  "21394", "21395", "21396", "21397", "21397.01", "21399", "21399.01", 
                  "21399.02", "21399.03", "21399.91", "21399.92", "21399.93", "213A", 
                  "213B", "213C", "213D", "214", "2141", "21411", "21412", "21419", 
                  "21419.01", "21419.02", "21419.03", "21419.99", "21419.91", "2142", 
                  "21421", "21422", "21423", "21424", "21429", "21429.01", "21429.02", 
                  "21429.03", "21429.04", "21429.05", "21429.07", "21429.90", "2143", 
                  "21431", "21431.01", "21431.02", "21432", "21432.01", "21433", 
                  "21433.01", "21434", "21435", "21435.01", "21435.02", "21439", 
                  "21439.01", "21439.02", "21439.03", "21439.04", "21439.05", "21439.06", 
                  "21439.07", "21439.08", "21439.9", "2149", "21491", "21492", 
                  "21493", "21493.01", "21493.02", "21494", "21494.01", "21494.02", 
                  "21495", "21495.01", "21495.02", "21495.90", "21496", "21496.01", 
                  "21496.02", "21499", "21499.01", "21499.02", "21499.03", "2149A", 
                  "2149B", "215", "2151", "21511", "21511.01", "21511.02", "21511.03", 
                  "21512", "21512.01", "21513", "21514", "21515", "21519", "21519.01", 
                  "21519.02", "21519.03", "2152", "21521", "21522", "21523", "21524", 
                  "21525", "21526", "21529", "21529.01", "21529.02", "21529.03", 
                  "2152A", "2153", "21531", "21532", "21533", "21534", "21535", 
                  "21536", "21537", "21538", "21539", "2154", "21541", "21542", 
                  "21543", "21544", "21545", "21546", "21547", "21548", "21549", 
                  "2155", "21550", "2159", "21590", "215A", "216", "2160", "2161", 
                  "21611", "21612", "2162", "21621", "21622", "2163", "21631", 
                  "21631.01", "21631.02", "21632", "21632.01", "21632.02", "2164", 
                  "21641", "21641.01", "21641.02", "21642", "21642.01", "21642.02", 
                  "2165", "21651", "21652", "2166", "21661", "21662", "2167", "21671", 
                  "21672", "21673", "2168", "21681", "21682", "2169", "21691", 
                  "21691.01", "21691.02", "21691.03", "21691.04", "21691.05", "21691.06", 
                  "21691.07", "21691.08", "21691.09", "21691.10", "21691.11", "21691.12", 
                  "21691.13", "21691.14", "21691.90", "21693", "21693.01", "21693.02", 
                  "21693.03", "21693.90", "217", "2170", "21700", "21700.01", "21700.02", 
                  "21700.90", "2171", "21710", "2172", "21720", "2173", "21731", 
                  "21732", "218", "2180", "21800", "219", "2191", "21910", "21910.01", 
                  "21910.02", "21910.03", "21910.04", "21910.05", "21910.06", "21910.07", 
                  "21910.08", "21910.09", "21910.10", "21910.11", "21910.12", "21910.13", 
                  "21910.14", "21910.15", "21910.16", "21910.17", "21910.90", "2192", 
                  "21920", "2193", "21931", "21932", "21932.01", "21932.02", "22", 
                  "221", "2211", "22110", "22110.01", "22110.02", "22110.03", "22110.04", 
                  "22110.05", "22110.06", "2212", "22120", "2213", "22130", "22130.01", 
                  "22130.02", "22130.03", "222", "2221", "22211", "22212", "22219", 
                  "2222", "22221", "22221.01", "22221.02", "22222", "22222.01", 
                  "22222.02", "22229", "2223", "22230", "22230.01", "22230.02", 
                  "22230.03", "22230.04", "2224", "22241", "22241.01", "22241.02", 
                  "22242", "22242.01", "22242.02", "22249", "22249.01", "22249.02", 
                  "2225", "22251", "22251.01", "22251.02", "22251.03", "22251.04", 
                  "22252", "22253", "22254", "22259", "2226", "22260", "2227", 
                  "22270", "2229", "22290", "223", "2230", "22300", "23", "231", 
                  "2311", "23110", "2312", "23120", "23120.01", "23120.02", "23120.03", 
                  "23120.04", "23120.05", "23120.06", "23120.07", "23120.08", "23120.09", 
                  "23120.10", "23120.90", "2313", "23130", "23130.01", "23130.02", 
                  "23130.03", "23130.04", "23130.05", "23130.06", "23130.07", "23130.08", 
                  "23130.09", "23130.10", "23130.11", "23130.90", "2314", "23140", 
                  "23140.01", "23140.02", "23140.03", "23140.04", "23140.05", "23140.06", 
                  "23140.07", "23140.08", "2316", "23161", "23161.01", "23161.02", 
                  "23161.03", "23162", "2317", "23170", "23170.01", "23170.02", 
                  "23170.03", "23170.04", "2318", "23180", "232", "2321", "23210", 
                  "23210.01", "23210.02", "23210.03", "23210.04", "23210.05", "23210.06", 
                  "23210.07", "23210.08", "2322", "23220", "23220.01", "23220.02", 
                  "23220.03", "23220.04", "23220.05", "23220.06", "2323", "23230", 
                  "23230.01", "23230.02", "233", "2331", "23311", "23319", "23319.01", 
                  "23319.02", "23319.03", "23319.04", "23319.05", "23319.06", "23319.07", 
                  "23319.08", "23319.09", "23319.10", "23319.11", "2332", "23320", 
                  "234", "2341", "23410", "2342", "23420", "2343", "23430", "2349", 
                  "23490", "23490.01", "23490.02", "235", "2351", "23511", "23511.01", 
                  "23511.02", "23512", "2352", "23520", "2353", "23530", "2354", 
                  "23540", "236", "2361", "23610", "23610.01", "23610.02", "2362", 
                  "23620", "2363", "23630", "2364", "23640", "2365", "23650", "2366", 
                  "23660", "2367", "23670", "23670.01", "23670.02", "236A", "236B", 
                  "237", "2371", "23710", "2372", "23721", "23722", "239", "2391", 
                  "23911", "23912", "23912.01", "23912.02", "23913", "23914", "2392", 
                  "23921", "23922", "23923", "23924", "23925", "23926", "23927", 
                  "23928", "23929", "2399", "23991", "23991.01", "23991.02", "23991.03", 
                  "23991.04", "23991.90", "23992", "23993", "23993.01", "23993.02", 
                  "23993.03", "23994", "23995", "23995.01", "23995.02", "23995.03", 
                  "23995.90", "23996", "23997", "23999", "23999.01", "23999.02", 
                  "23999.03", "23999.04", "23999.90", "24", "241", "2411", "24110", 
                  "2413", "24131", "24139", "242", "2421", "24211", "24212", "24212.01", 
                  "24212.02", "2422", "24220", "2423", "24230", "24230.01", "24230.02", 
                  "24230.03", "242A", "243", "2431", "24310", "24310.01", "24310.02", 
                  "24310.03", "24310.04", "24310.90", "2432", "24320", "244", "2441", 
                  "24410", "2449", "24490", "24490.01", "24490.02", "24490.03", 
                  "24490.04", "24490.91", "24490.92", "25", "250", "2501", "25010", 
                  "2502", "25020", "25020.01", "25020.02", "2509", "25090", "26", 
                  "261", "2611", "26110", "2613", "26130", "2614", "26140", "2615", 
                  "26150", "26150.01", "26150.02", "2616", "26160", "2617", "26170", 
                  "26170.01", "26170.02", "2619", "26190", "26190.01", "26190.02", 
                  "26190.03", "26190.04", "26190.05", "26190.06", "26190.07", "26190.08", 
                  "26190.09", "26190.90", "262", "2621", "26210", "2622", "26220", 
                  "263", "2631", "26310", "2632", "26320", "2633", "26330", "2634", 
                  "26340", "2635", "26350", "2636", "26360", "2637", "26370", "2638", 
                  "26380", "264", "2641", "26410", "2642", "26420", "26421", "2643", 
                  "26430", "2644", "26440", "2645", "26450", "2646", "26460", "26461", 
                  "265", "2651", "26510", "2652", "26520", "2653", "26530", "2654", 
                  "26540", "2655", "26550", "2656", "26560", "2657", "26570", "2659", 
                  "26590", "266", "2661", "26610", "2662", "26620", "2663", "26630", 
                  "2669", "26690", "267", "2671", "26710", "2672", "26720", "2673", 
                  "26730", "2674", "26740", "2675", "26750", "2676", "26760", "2677", 
                  "26770", "2679", "26790", "268", "2681", "26810", "2682", "26820", 
                  "2683", "26830", "2684", "26840", "2685", "26850", "2686", "26860", 
                  "2688", "26880", "2689", "26890", "27", "271", "2711", "27110", 
                  "2712", "27120", "2713", "27130", "2714", "27140", "2715", "27150", 
                  "2716", "27160", "2717", "27170", "2718", "27180", "2719", "27190", 
                  "272", "2721", "27210", "2722", "27220", "2723", "27230", "2729", 
                  "27290", "273", "2731", "27310", "2732", "27320", "279", "2791", 
                  "27911", "27912", "27913", "2792", "27921", "27922", "2799", 
                  "27991", "27992", "27993", "27994", "27995", "27996", "27997", 
                  "27998", "27999", "28", "281", "2811", "28110", "2819", "28190", 
                  "282", "2821", "28210", "2822", "28221", "28222", "28223", "28224", 
                  "28225", "28226", "28227", "28228", "28229", "2823", "28231", 
                  "28232", "28233", "28234", "28235", "28236", "28237", "28238", 
                  "2824", "28241", "28242", "28243", "2825", "28250", "2826", "28261", 
                  "28262", "28269", "283", "2831", "28310", "2832", "28320", "2833", 
                  "28330", "29", "291", "2911", "29110", "2912", "29120", "2913", 
                  "29130", "292", "2921", "29210", "2922", "29220", "2923", "29230", 
                  "2929", "29290", "293", "2931", "29310", "2932", "29320", "2933", 
                  "29330", "2934", "29340", "294", "2941", "29410", "2942", "29420", 
                  "2949", "29490", "295", "2951", "29510", "2952", "29520", "296", 
                  "2960", "29600", "3", "31", "311", "3110", "31100", "31101", 
                  "31102", "31109", "312", "3121", "31210", "31211", "31212", "31219", 
                  "3122", "31220", "3123", "31230", "313", "3131", "31310", "3132", 
                  "31320", "3133", "31330", "314", "3141", "31410", "31411", "31412", 
                  "3142", "31420", "31421", "31422", "3143", "31430", "31431", 
                  "31432", "31439", "3144", "31440", "31441", "31442", "31449", 
                  "3145", "31450", "315", "3151", "31510", "31511", "31512", "3152", 
                  "31520", "316", "3160", "31600", "317", "3170", "31700", "319", 
                  "3191", "31911", "31912", "31913", "31914", "3192", "31921", 
                  "31922", "31923", "32", "321", "3211", "32111", "32112", "32113", 
                  "3212", "32121", "32122", "32129", "3213", "32131", "32132", 
                  "32133", "32134", "32135", "32136", "32137", "3214", "32141", 
                  "32142", "32143", "32149", "3215", "32151", "32152", "32153", 
                  "3219", "32191", "32192", "32193", "32194", "32195", "32196", 
                  "32197", "32198", "32199", "322", "3221", "32210", "3222", "32220", 
                  "3223", "32230", "3229", "32291", "32292", "32299", "323", "3230", 
                  "32300", "324", "3241", "32410", "3242", "32420", "3249", "32490", 
                  "325", "3251", "32511", "32512", "3252", "32520", "3253", "32530", 
                  "3254", "32540", "3255", "32550", "326", "3261", "32610", "3262", 
                  "32620", "3263", "32630", "3269", "32690", "327", "3270", "32700", 
                  "328", "3280", "32800", "33", "331", "3310", "33100", "332", 
                  "3320", "33200", "333", "3331", "33310", "3332", "33320", "3333", 
                  "33330", "3334", "33341", "33342", "3335", "33350", "3336", "33360", 
                  "3337", "33370", "3338", "33380", "334", "3341", "33410", "3342", 
                  "33420", "33421", "33429", "335", "3350", "33500", "336", "3361", 
                  "33610", "3362", "33620", "3363", "33630", "3369", "33690", "337", 
                  "3371", "33710", "3372", "33720", "34", "341", "3411", "34110", 
                  "3412", "34120", "3413", "34131", "34139", "3414", "34140", "3415", 
                  "34150", "3416", "34160", "3417", "34170", "3418", "34180", "342", 
                  "3421", "34210", "3422", "34220", "3423", "34231", "34232", "34233", 
                  "3424", "34240", "3425", "34250", "3426", "34260", "3427", "34270", 
                  "3428", "34280", "3429", "34290", "343", "3431", "34310", "3432", 
                  "34320", "3433", "34330", "3434", "34340", "344", "3440", "34400", 
                  "345", "3451", "34510", "3452", "34520", "3453", "34530", "3454", 
                  "34540", "3455", "34550", "3456", "34560", "3457", "34570", "346", 
                  "3461", "34611", "34612", "34613", "34614", "34615", "34616", 
                  "34619", "3462", "34621", "34629", "3463", "34631", "34632", 
                  "34639", "3464", "34641", "34642", "34643", "34644", "34645", 
                  "34646", "34649", "3465", "34651", "34652", "34653", "34654", 
                  "34659", "3466", "34661", "34662", "34663", "34664", "34666", 
                  "34669", "347", "3471", "34710", "3472", "34720", "3473", "34730", 
                  "3474", "34740", "3479", "34790", "348", "3480", "34800", "35", 
                  "351", "3511", "35110", "3512", "35120", "3513", "35130", "3514", 
                  "35140", "352", "3521", "35210", "3522", "35220", "3523", "35230", 
                  "3524", "35240", "3525", "35250", "3526", "35260", "3527", "35270", 
                  "3529", "35290", "353", "3531", "35310", "3532", "35321", "35322", 
                  "35323", "3533", "35331", "35332", "35333", "35334", "354", "3541", 
                  "35410", "35410.01", "35410.90", "3542", "35420", "3543", "35430", 
                  "3544", "35440", "3545", "35450", "3546", "35460", "3547", "35470", 
                  "3549", "35490", "35491", "35499", "355", "3551", "35510", "3552", 
                  "35520", "3553", "35530", "3554", "35540", "3555", "35550", "3556", 
                  "35560", "36", "361", "3611", "36111", "36112", "36113", "36114", 
                  "36115", "3612", "36120", "362", "3621", "36210", "3622", "36220", 
                  "3623", "36230", "3624", "36240", "3625", "36250", "3626", "36260", 
                  "3627", "36270", "363", "3631", "36310", "3632", "36320", "3633", 
                  "36330", "3639", "36390", "364", "3641", "36410", "3649", "36490", 
                  "369", "3691", "36910", "3692", "36920", "3693", "36930", "3694", 
                  "36940", "3695", "36950", "3696", "36960", "3697", "36971", "36972", 
                  "3698", "36980", "3699", "36990", "37", "371", "3711", "37111", 
                  "37112", "37113", "37114", "37115", "37116", "37117", "3712", 
                  "37121", "37129", "3719", "37191", "37192", "37193", "37194", 
                  "37195", "37196", "37197", "37199", "372", "3721", "37210", "3722", 
                  "37221", "37222", "3729", "37291", "37292", "37299", "373", "3731", 
                  "37310", "3732", "37320", "3733", "37330", "3734", "37340", "3735", 
                  "37350", "3736", "37360", "3737", "37370", "374", "3741", "37410", 
                  "3742", "37420", "3743", "37430", "3744", "37440", "3745", "37450", 
                  "375", "3751", "37510", "3752", "37520", "3753", "37530", "3754", 
                  "37540", "3755", "37550", "3756", "37560", "3757", "37570", "376", 
                  "3761", "37610", "3769", "37690", "379", "3791", "37910", "3792", 
                  "37920", "3793", "37930", "3794", "37940", "3795", "37950", "3796", 
                  "37960", "3799", "37990", "38", "381", "3811", "38111", "38112", 
                  "38119", "3812", "38121", "38122", "3813", "38130", "3814", "38140", 
                  "3815", "38150", "3816", "38160", "382", "3821", "38210", "3822", 
                  "38220", "3823", "38230", "3824", "38240", "3825", "38250", "383", 
                  "3831", "38310", "3832", "38320", "3833", "38330", "3834", "38340", 
                  "3835", "38350", "3836", "38360", "384", "3841", "38410", "3842", 
                  "38420", "3843", "38430", "3844", "38440", "3845", "38450", "385", 
                  "3851", "38510", "3852", "38520", "3853", "38530", "3854", "38540", 
                  "3855", "38550", "3856", "38560", "3857", "38570", "3858", "38581", 
                  "38582", "3859", "38590", "386", "3860", "38600", "387", "3870", 
                  "38701", "38702", "38703", "38704", "389", "3891", "38911", "38912", 
                  "3892", "38921", "38922", "38923", "38924", "3893", "38930", 
                  "3894", "38941", "38942", "3895", "38950", "3896", "38961", "38962", 
                  "38963", "3897", "38971", "38972", "3899", "38991", "38992", 
                  "38993", "38994", "38995", "38996", "38997", "38998", "38999", 
                  "39", "391", "3911", "39110", "39110.01", "39110.02", "39110.90", 
                  "3912", "39120", "39120.01", "39120.02", "39120.03", "39120.04", 
                  "39120.05", "39120.06", "39120.07", "39120.08", "39120.09", "39120.10", 
                  "39120.11", "39120.12", "39120.13", "39120.14", "39120.15", "39120.16", 
                  "39120.17", "39120.91", "3913", "39130", "39130.01", "39130.02", 
                  "39130.03", "39130.04", "3914", "39140", "39140.01", "39140.02", 
                  "39141", "39149", "3915", "39150", "39150.01", "39150.02", "3916", 
                  "39160", "3917", "39170", "39170.01", "39170.02", "3918", "39180", 
                  "392", "3921", "39211", "39212", "39213", "39214", "39215", "39216", 
                  "39217", "39218", "3921A", "3922", "39220", "3923", "39230", 
                  "3924", "39240", "3925", "39250", "3926", "39260", "3927", "39270", 
                  "3928", "39280", "3929", "39290", "393", "3931", "39310", "3932", 
                  "39320", "3933", "39331", "39332", "39333", "3934", "39340", 
                  "3935", "39350", "3936", "39361", "39362", "39363", "39364", 
                  "39365", "39366", "39367", "39368", "3937", "39370", "3938", 
                  "39380", "399", "3991", "39910", "3992", "39920", "3993", "39931", 
                  "39939", "3994", "39940", "3995", "39950", "3999", "39990", "21121i", 
                  "21121b", "21119.01i", "21119.01b", "21118.03i", "21118.03b", 
                  "21118.02i", "21118.02b", "21118.01i", "21118.01b", "21117.02i", 
                  "21117.02b", "21117.01i", "21117.01b", "21116i", "21116b", "21115i", 
                  "21170.01b", "21114i", "21114b", "21113.01i", "21113.01b", "21112i", 
                  "21112b", "21111.01i", "21115b", "21170.01i", "21124i", "21124b", 
                  "39120.18", "2351f", "21111.01b", "21123i", "21123b", "21122i", 
                  "21122b")

## We need different area codes for the SUA domain
# yearsForSD <- as.numeric(swsContext.computationParams$yearsForVar)
# yearsForSD <- as.numeric(swsContext.datasets[[1]]@dimensions$timePointYears@keys)
## We will need the year of imputation as well as previous years to compute the
## standard deviation.  We'll grab as many years as specified by the user.
# yearCodes <- as.numeric(swsContext.computationParams$yearToProcess) +
#     (-yearsForSD:0)
# yearCodes <- as.character(yearCodes)
# yearCodes <- swsContext.datasets[[1]]@dimensions$timePointYears@keys
## We need the previous year to compute change in GDP.  This allows us to
## calculate food in the new year.
yearCodes <- as.numeric(swsContext.computationParams$yearToProcess) + -1:15
yearCodes <- as.character(yearCodes)
## GDP per capita (constant 2500 US$) is under this key
gdpCodes <- "NY.GDP.PCAP.KD"
## The element 21 contains the FBS population numbers
populationCodes <- "21"
## The element 141 contains the FBS food numbers

comCodes <- GetCodeList("food", "food_factors","foodCommodityM")$code
fdmCodes <- GetCodeList("food", "food_factors","foodFdm")$code
funCodes <- GetCodeList("food", "food_factors","foodFunction")$code
varCodes <- "y_e" ## Only need elasticities from the food domain table

## Define the dimensions
dimM49 <- Dimension(name = "geographicAreaM49", keys = areaCodesM49)
dimPop <- Dimension(name = "measuredElementPopulation", keys = populationCodes)
dimTime <- Dimension(name = "timePointYears", keys = yearCodes)
dimGDP <- Dimension(name = "wbIndicator", keys = gdpCodes)

dimCom <- Dimension(name = "foodCommodityM", keys = comCodes)
dimFdm <- Dimension(name = "foodFdm", keys = fdmCodes)
dimFun <- Dimension(name = "foodFunction", keys = funCodes)
dimVar <- Dimension(name = "foodVariable", keys = varCodes)

## Define the pivots.  We won't need this for all dimensions, so we'll only
## define the relevant ones.
pivotM49 <- Pivoting(code = "geographicAreaM49")
pivotPop <- Pivoting(code = "measuredElementPopulation")
pivotTime <- Pivoting(code = "timePointYears")
pivotGDP <- Pivoting(code = "wbIndicator")

## Define the keys
keyPop <- DatasetKey(domain = "population", dataset = "population",
                     dimensions = list(dimM49, dimPop, dimTime))
keyGDP <- DatasetKey(domain = "WorldBank", dataset = "wb_ecogrw",
                     dimensions = list(dimM49, dimGDP, dimTime))
keyFdm <- DatasetKey(domain = "food", dataset = "food_factors",
                     dimensions = list(dimM49, dimCom, dimFdm, dimFun, dimVar))

## Download all the datasets:
cat("Download all the datasets...\n")

## download the population data from the SWS.  Using the pivoting argument, we 
## can specify the column order.  Since we're only pulling one key for the 
## population dimension, it makes sense to use that as the last dimension with 
## normalized = FALSE.  Doing this makes the last column the population, and
## names it Value_measuredElementPopulation_21.  We'll just rename it to
## population.
popData <- GetData(keyPop, flags=FALSE, normalized = FALSE,
                   pivoting = c(pivotM49, pivotTime, pivotPop))
setnames(popData, "Value_measuredElementPopulation_21", "population")

## download the gdp data from the SWS.  We're again only pulling one wbIndicator
## dimension, so we'll do the same thing we did for population.
gdpData <- GetData(keyGDP, flags=FALSE, normalized = FALSE,
                   pivoting = c(pivotM49, pivotTime, pivotGDP))
setnames(gdpData, "Value_wbIndicator_NY.GDP.PCAP.KD", "GDP")

## download the food data from the SWS
foodData <- getFoodData(timePointYears = yearCodes, areaCodesM49 = areaCodesM49,
#                        commCodesCPC = swsContext.datasets[[1]]@dimensions$measuredItemCPC@keys)
                         commCodesCPC = itemCodesCPC)
setnames(foodData, "Value", "food")

## Get the food classification for each commodity and select only the 
## commodities that should have figures in the food module. In this case we'll
## use just commodities with the food classification "Food Estimate". For the 
## commodities classified as a "Food residual", we need to check if there is
## net trade for them.
foodData[, type := getCommodityClassification(measuredItemCPC)]
foodData = foodData[type %in% c("Food Estimate", "Food residual", "Food Residual")]



cpc <- c("01211", "01212", "01213", "01214", "01215", "01216", "01221", 
         "01229", "01231", "01232", "01233", "01234", "01235", "01241.90", 
         "01242", "01243", "01251", "01252", "01253.01", "01253.02", "01254", 
         "01270", "01290.90", "01311", "01312", "01313", "01314", "01315", 
         "01316", "01317", "01318", "01319", "01321", "01322", "01323", 
         "01324", "01329", "01330", "01341", "01342.01", "01342.02", "01343", 
         "01344.01", "01344.02", "01345", "01346", "01349.20", "01351.01", 
         "01351.02", "01352", "01353.01", "01354", "01355.01", "01355.02", 
         "01355.90", "01359.90", "01371", "01372", "01373", "01374", "01375", 
         "01377", "01379.90", "0141", "01442", "01444", "01445", "01449.01", 
         "01450", "01460", "01510", "01530", "01591", "01620", "01630", 
         "01651", "01652", "01653", "01654", "01655", "01656", "01657", 
         "01658", "01691", "01699", "01701", "01703", "01704", "01705", 
         "01930.01", "02211", "02212", "02292", "0231", "0232", "02910", 
         "02920", "17400", "21111.01", "21111.02", "21112", "21113.02", 
         "21114", "21115", "21116", "21118.01", "21118.02", "21121", "21122", 
         "21123", "21124", "21151", "21152", "21153", "21155", "21156", 
         "21160.01", "21160.02", "21160.04", "21181", "21182", "21183", 
         "21184.02", "21185", "21189.04", "21313", "21319.01", "21321", 
         "21340", "21392", "21393.01", "21393.90", "21397.01", "21399.01", 
         "21399.02", "21399.03", "21411", "21412", "21419.01", "21419.02", 
         "21419.91", "21419.99", "21421", "21422", "21423", "21424", "21429.01", 
         "21429.02", "21429.07", "21431.01", "21431.02", "21432", "21432.01", 
         "21433", "21433.01", "21434", "21435.01", "21435.02", "21439.02", 
         "21439.04", "21439.05", "21491", "21495.01", "21495.02", "21511.02", 
         "21511.03", "21512", "21514", "21521", "21523", "2161", "2162", 
         "21631.01", "2167", "21673", "21691.02", "21700.01", "21700.02", 
         "22110.02", "22120", "22130.01", "22211", "22212", "22221.01", 
         "22222.01", "22230.02", "22230.03", "22241.01", "22241.02", "22251.01", 
         "22251.02", "22251.03", "22251.04", "22253", "22254", "22270", 
         "22290", "23110", "23120.01", "23120.02", "23120.03", "23120.04", 
         "23140.03", "23140.04", "23140.05", "23140.07", "23140.08", "23161.01", 
         "23161.02", "23162", "23170.02", "23170.04", "23180", "23210.03", 
         "23210.04", "23210.06", "23230.01", "23520", "23530", "23670.01", 
         "23670.02", "23710", "23911", "23912.01", "23912.02", "23914", 
         "23991.01", "23991.02", "23991.03", "23991.04", "23993.02", "23993.03", 
         "23995.01", "23995.03", "23999.01", "23999.02", "2413", "24212.01", 
         "24212.02", "24220", "24230.03", "24310.01", "0114", "0115", 
         "01199.90", "01379.01", "01706", "01707", "01802", "01990.01", 
         "02291", "21113.01", "21170.01", "21511.01", "21513", "21515", 
         "21641.01", "2165", "2166", "2168", "21691.07", "21691.14", "23120.05", 
         "23120.90", "23170.01", "23210.05", "23511.02", "0117", "01192", 
         "01520.01", "01540", "01550", "01709.90", "21160.03", "21529.03", 
         "21691.90", "22249.01", "22260", "23120.06", "23170.03", "23220.01", 
         "23220.02", "23220.04", "23993.01", "24310.03", "24310.04", "0113", 
         "01290.01", "01376", "0142", "01659", "21159.01", "21631.02", 
         "22230.01", "23161.03", "23210.01", "23610.01", "23620", "24320", 
         "0118", "01801", "21189.05", "21329", "21641.02", "22130.02", 
         "22130.03", "23120.10", "23210.02", "23210.08", "23220.03", "23230.02", 
         "01239.01", "01359.01", "01702", "01809", "02293", "21117.01", 
         "21159.02", "21519.02", "22221.02", "22222.02", "23220.06", "01379.02", 
         "01708", "21170.02", "23140.01", "23220.05", "01448", "21170.93", 
         "21184.01", "21439.03", "22230.04", "23120.07", "24230.02", "24310.02", 
         "39120.09", "21118.03", "21439.08", "21499.01", "21691.01", "22110.04", 
         "22242.01", "22252", "23120.09", "39120.01", "39120.02", "01599.10", 
         "01599.20", "21691.03", "0111", "01709.02", "21522", "22110.03", 
         "0112", "01194", "01241.01", "22249.02", "01219.01", "01930.04", 
         "23140.02", "01199.02", "21439.06", "01441", "01193", "23120.08", 
         "01709.01", "21691.12", "01359.02", "21529.02", "23511.01", "21439.01", 
         "39120.13", "22242.02", "22110.05", "23995.02", "21190.01", "21691.08", 
         "21910.09", "23540", "23999.03", "24230.01", "21512.01", "22110.06", 
         "39130.02", "21117.02", "21119.01", "21519.03", "39120.05", "01349.10", 
         "39120.14", "22110.01", "39120.04")

commodities <- data.table(cpc = cpc)
head(commodities)
commodities <- commodities[!(cpc %in% c("0112", "01241.90", "21419.91", "21419.99", "01599.20"))]
commodities

funcCodes <- commodity2FunctionalForm(
    as.numeric(cpc2fcl(commodities$cpc, returnFirst = TRUE)))



# funcCodes <- commodity2FunctionalForm(
#         as.numeric(cpc2fcl(foodData$measuredItemCPC, returnFirst = TRUE)))
foodData <- cbind(foodData, do.call("cbind", funcCodes))

# foodData <- foodData[!is.na(foodDemand), ]
cat("Food data downloaded with", nrow(foodData), "rows.\n")

## download the food dimension data (elasticities) from the SWS
fdmData <- GetData(keyFdm, flags=FALSE, normalized = FALSE)
setnames(fdmData, "Value_foodVariable_y_e", "elasticity")
setnames(fdmData, "foodFdm", "foodDemand")
setnames(fdmData, "foodCommodityM", "foodCommodity")

# read map table from old code to new code
oldToNewCommodity = ReadDatatable("food_old_code_map")

fdmData <- merge(fdmData, oldToNewCommodity, all.x = T, allow.cartesian = T, 
                 by.x="foodCommodity", by.y = "old_code")
fdmData[is.na(new_code), new_code := foodCommodity]
fdmData <- fdmData[foodCommodity != "2500"]
fdmData[, c("foodCommodity") := NULL]
setnames(fdmData, old=c("new_code"), new=c("foodCommodity"))

fdmData <- fdmData[, list(elasticity = max(elasticity)), 
                   by=list(geographicAreaM49, foodDemand, foodFunction)]

## Trade

tradeCode <- c("5610", "5910")

totalTradeKey = DatasetKey(
    domain = "trade",
    dataset = "total_trade_cpc_m49",
    dimensions = list(
        Dimension(
            name = "geographicAreaM49",
            keys = GetCodeList("trade", "total_trade_cpc_m49", "geographicAreaM49")[, code]
        ),
        Dimension(name = "measuredElementTrade", keys = tradeCode),
        Dimension(name = "timePointYears", keys = as.character(2009:2013)),
        Dimension(
            name = "measuredItemCPC",
            keys = GetCodeList("trade", "total_trade_cpc_m49", "measuredItemCPC")[, code]
        )
    )
)

totalTradeData <- GetData(totalTradeKey, flags = F)
totalTradeData <- dcast.data.table(totalTradeData, geographicAreaM49 + measuredItemCPC + 
                     timePointYears ~ measuredElementTrade, value.var = "Value")

setnames(totalTradeData, "5610", "imports")
setnames(totalTradeData, "5910", "exports")

totalTradeData[is.na(imports), imports := 0]
totalTradeData[is.na(exports), exports := 0]
totalTradeData[, netTrade := (imports - exports)]

## Merge the datasets together, and perform some processing.

cat("Merge population with GDP...\n")
## merge the current population and gross domestic product data into a single
## dataset
data <- merge(popData, gdpData, all = TRUE,
              by = c("geographicAreaM49", "timePointYears"))

cat("Merge in food data...\n")
data = merge(foodData, data, all.x = TRUE,
             by = c("geographicAreaM49", "timePointYears"))

cat("Merge in food demand model data...\n")
data <- merge(data, fdmData,
              by = c("foodDemand", "geographicAreaM49"),
              all.x = TRUE)

## Let's merge data and totalTradeData
keys <- c("geographicAreaM49", "timePointYears", "measuredItemCPC")
data <- merge(data, totalTradeData[, c("geographicAreaM49", "timePointYears",
                                       "measuredItemCPC", "netTrade"), with = F],
              by = keys, all.x = T)

data <- data[timePointYears %in% c(2010, 2011)]


if(nrow(data) == 0){
    warning("data has no rows, so the module is ending...  Are you sure there ",
            "are observations for food for these commodities?")
    stats = list(inserted = 0, ignored = 0, discarded = 0)
} else {

    ## First, sort the data by area and time.  The time sorting is important as we
    ## will later assume row i+1 is one time step past row i.
    setkeyv(data, c("geographicAreaM49", "timePointYears"))
    
    cat("Estimate food using the food model...\n")
    ## The funcional form 4 (originally presented in Josef's data) was replaced by
    ## functional form 3 The functional form 32 is a typo. It was replaced by
    ## functional form 2 in Food Factors database.
    data[, foodFunction := ifelse(foodFunction == 4, 3, foodFunction)]
    data[, foodHat := calculateFood(food = .SD$food, elas = .SD$elasticity,
                                    #gdp_pc = .SD$GDP/.SD$population,
                                    gdp_pc = .SD$GDP,
                                    ## We can use the first value since they're all the same:
                                    functionalForm = max(.SD$foodFunction, na.rm = TRUE),
                                    pop = .SD$population,
                                    trend_factor = 0),
         by = c("measuredItemCPC", "geographicAreaM49")]
    
    ## Incorporating total trade data. If the commodity is "food residual" we 
    ## have to check the net trade data.
    data[type %in% c("Food residual", "Food Residual") & netTrade > 0, 
         foodHat := netTrade]
    data[type %in% c("Food residual", "Food Residual") & netTrade <= 0, 
         foodHat := 0]
    
    # In statistics, a forecast error is the difference between the actual or real
    # and the predicted or forecast value of a time series or any other phenomenon
    # of interest.
    # In simple cases, a forecast is compared with an outcome at a single
    # time-point and a summary of forecast errors is constructed over a collection
    # of such time-points. Here the forecast may be assessed using the difference
    # or using a proportional error.
    # By convention, the error is defined using the value of the outcome minus the
    # value of the forecast.
    data[, error := food - foodHat]
    
    # Geographic Area, measuredElement = 141, measuredItem = SUA item code, Dist
    # Param = log(Mu) or log(Sigma), Year = Year
    # dataToSave <- data_base[,
    #     ## Since we're ordered by time, foodHat[.N] will give the last estimate for
    #     ## the food element, and this is exactly what we want.
    #     list(mean = foodHat[.N],
    #          var = mean(error^2, na.rm = TRUE),
    #          timePointYears = max(timePointYears)),
    #     by = c("geographicAreaM49", "measuredElement", "measuredItemCPC")]
    dataToSave <- data[timePointYears > swsContext.computationParams$yearToProcess, ]
    
    ## To convert from mu/sigma to logmu/logsigma, we can use the method of moments
    ## estimators (which express the parameters of the log-normal distribution in
    ## terms of the moments).  The formula are:
    ## logmu = 2*log(E(X)) - 1/2*log(E(X^2))
    ## logsigma = log(E(X^2)) - 2*log(E(X))
    ## We can write E(X^2) = sigma^2 + E(X)^2, and so we can now easily express
    ## logmu and logsigma from the estimated expected value and variance.
    
    # dataToSave[, lmu := 2*log(mean)-1/2*log(var+mean^2)]
    # dataToSave[, lsi := log(var+mean^2) - 2*log(mean)]
    # ## Remove mean and var now that we've calculate lmu and lsi
    # dataToSave[, c("mean", "var") := NULL]
    # dataToSave = data.table:::melt.data.table(dataToSave,
    #     measure.vars = c("lmu", "lsi"))
    
    ## Prepare data and save it to SWS
    cat("Restructure and filter data to save to SWS...\n")
    setnames(dataToSave, "foodHat", "Value")
    dataToSave[, measuredElement := "5141"]
    dataToSave <- dataToSave[, c("geographicAreaM49", "measuredElement",
                                 "measuredItemCPC", "timePointYears", "Value"),
                             with = FALSE]
    
    keys = c("geographicAreaM49", "measuredElement",
             "measuredItemCPC", "timePointYears")
    
    # Remove official data from dataToSave.  foodData has the official data, just
    # need to remove missing and imputed.
    
    # By now there are no data for food in the agriculture/aproduction before 2011.
    # This table should be populate by the table in the old system (food code 141).
    # As the flagObservationStatus and flagMethod are only NA, we assume that these 
    # figures are not officials. Thus, we'll save all the data computed for 2011.

    # foodData = foodData[!flagObservationStatus %in% overwritableFlags &
    #                     !is.na(flagObservationStatus), ]
    # dataToSave = merge(dataToSave, foodData[, c(keys, "food"), with = FALSE],
    #           all.x = TRUE, by = keys)
    # dataToSave = dataToSave[is.na(food), ]
    # dataToSave[, food := NULL]
    
    dataToSave[, flagObservationStatus := "I"]
    dataToSave[, flagMethod := "e"]
    dataToSave = dataToSave[!is.na(Value), ]
    
    cat("Save the final data...\n")
    
    stats = SaveData(domain = "agriculture", dataset = "aproduction", data = dataToSave)
}

paste0(stats$inserted, " observations written, ",
       stats$ignored, " weren't updated, ",
       stats$discarded, " had problems.")
